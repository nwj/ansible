---
- hosts: bootstrap
  remote_user: root
  gather_facts: no
  tasks:
    - name: Install python
      raw: test -e /usr/bin/python || (apt update && apt install -y python-minimal)
      register: python_already_installed
      changed_when: python_already_installed.stdout

    - name: Add the admin user
      user:
        name: "{{ admin_username }}"
        password: "{{ admin_password }}"
        shell: /bin/bash
        state: present

    - name: Give the admin user an ssh key
      authorized_key:
        user: "{{ admin_username }}"
        key: "{{ lookup('file', admin_ssh_public_key_path) }}"
        state: present

    - name: Create the 'wheel' group
      group:
        name: wheel
        state: present

    - name: Give the 'wheel' group passwordless sudo access
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "^%wheel"
        line: "%wheel ALL=(ALL) NOPASSWD: ALL"
        validate: "/usr/sbin/visudo -cf %s"

    - name: Add the admin user to the 'wheel' group
      user:
        name: "{{ admin_username }}"
        group: wheel
        append: yes

- hosts: all
  remote_user: "{{ admin_username }}"
  become: yes
  roles:
    - common

